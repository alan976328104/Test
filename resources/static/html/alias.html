<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">

<title>标签管理</title>
<script src="../assets/js/jquery-1.9.1.min.js"></script>

<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="pageoffice.js" id="po_js_main"></script>

<script src="../assets/js/alldata.js"></script>
<!--bootstrap-table-->
<script src="../assets/js/bootstrap/bootstrap-table.js"></script>
<link href="../assets/css/bootstrap/bootstrap-table.css"
	rel="stylesheet">
<link href="../assets/css/bootstrap/bootstrap.min.css" rel="stylesheet">
<link href="../assets/css/font-awesome.min.css" rel="stylesheet">
<!--[if IE 7]>
    <link rel="stylesheet" href="../assets/css/font-awesome-ie7.min.css">
<![endif]-->

<link rel="stylesheet" href="../assets/css/zTreeStyle.css"
	type="text/css">
<script type="text/javascript" src="../assets/js/jquery.ztree.core.js"></script>
<script type="text/javascript"
	src="../assets/js/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="../assets/js/jquery.ztree.exedit.js"></script>

<script src="../assets/js/bootstrap/bootstrap.min.js"></script>
<link href="../assets/css/bootstrap/bootstrap-dialog.css"
	rel="stylesheet">
<script src="../assets/js/bootstrap/bootstrap-dialog.js"></script>
<script src="../assets/js/vue/vue.js"></script>
<link rel="stylesheet" href="../assets/css/newstyle.css">


<style>
body::-webkit-scrollbar {
	display: none;
}

li {
	list-style: none;
	cursor: pointer;
}

.per-class {
	background-color: #EFEDC2;
	border-radius: 5px;
	padding: 3px;
}

.sys-class {
	background-color: #C2E1EF;
	border-radius: 5px;
	padding: 3px;
}

.per-i {
	color: #FBD349;
}

.sys-i {
	color: #1B94C8;
}

.tobar .btn {
	background: #0085ff !important;
	color: #fff;
}

.tobar .btn:hover {
	background: #fff !important;
	color: #333;
}

#toolbar .btn:hover {
	color: #333 !important;
}

.ztree li a:hover {
	/* color: #4fc1e9; */
	
}

.ztree li .curSelectedNode span:last-child {
	background-color: #4fc1e9;
	color: #fff;
}
ul{
overflow: auto;
}
/* ul::-webkit-scrollbar {
        display: none;
    } */
    #div_deptUser>.bootstrap-table>.fixed-table-pagination>.pull-left>.page-list{
display: none !important;
}
#div_deptUser>.bootstrap-table>.fixed-table-pagination>.pull-right>.pagination-jump{
display: none !important;
}
#div_deptUser>.bootstrap-table>.fixed-table-pagination>.pull-right>.pagination>.page-item{
display: none !important;
}
#div_deptUser>.bootstrap-table>.fixed-table-pagination>.pull-right>.pagination>.page-pre,.page-next{
display: inline !important;
}
#div_deptUser>.bootstrap-table>.fixed-table-pagination>.pull-right>.pagination>.page-next{
display: inline !important;
}

#div_user>.bootstrap-table>.fixed-table-pagination>.pull-left>.page-list{
display: none !important;
}
#div_user>.bootstrap-table>.fixed-table-pagination>.pull-right>.pagination-jump{
display: none !important;
}
#div_user>.bootstrap-table>.fixed-table-pagination>.pull-right>.pagination>.page-item{
display: none !important;
}
#div_user>.bootstrap-table>.fixed-table-pagination>.pull-right>.pagination>.page-pre,.page-next{
display: inline !important;
}
#div_user>.bootstrap-table>.fixed-table-pagination>.pull-right>.pagination>.page-next{
display: inline !important;
}
</style>

<script>
//获取登录者信息
var sessionUser;
$.ajax({
	type : "post",
	url : "/getSessionByIp",
	async : false,
	success : function(data) {
		if(data!=null){
			sessionUser=data
		}else{
			location.href = 'login.html';
		}
	}
})
	var lang = getUrlParam("lang");
	var columns, usercolumns;
	var tabledata = [];
	if (lang != "en_US") {
		usercolumns = [ [ {
			field : 'ck',
			checkbox : true,
			width : '1%'
		}, {
			field : 'username',
			title : '姓名',
			width : '20%'
		},{
			field : 'deptname',
			title : '部门'
		}] ]
		columns = [ [ {
			field : 'files.fileId',
			title : '#',
			width : '0.5%',
			cellStyle : function(row, index) {
				var style = {};
				style = {
					css : {
						'display' : 'none'
					}
				};
				return style;
			}
		}, {
			field : 'check',
			checkbox : true,
			width : '0.5%',
			formatter : function(value, row, index) {
				if (row.check == true) {
					// console.log(row.serverName);
					//设置选中
					return {
						checked : true
					};
				}
			}
		}, {
			field : 'files.fileName',
			title : '名称',
			width : "30%",
			formatter : forma
		}, {
			field : 'files.security.securityName',
			title : '密级',
			width : "5%"
		}, {
			field : 'files.fileVersion',
			title : '版本',
			width : "5%"
		}, {
			field : 'aliasDate',
			title : '标签日期',
			sortable : true,
			width : "15%"
		}, {
			field : 'files.user.username',
			title : '发布人',
			width : "8%"
		},  {
			field : 'files.location',
			title : '路径',
			formatter:formatUrl
		}  ] ]
		document
				.write("<script src='../assets/js/bootstrap/bootstrap-table-zh-CN.js' >"
						+ "<" + "/script>");
	} else {
		usercolumns = [ [ {
			field : 'ck',
			checkbox : true,
			width : '1%'
		}, {
			field : 'username',
			title : 'userName',
			width : '20%'
		},{
			field : 'deptname',
			title : 'deptName'
		}] ]
		columns = [ [ {
			field : 'files.fileId',
			title : '#',
			width : '0.5%',
			cellStyle : function(row, index) {
				var style = {};
				style = {
					css : {
						'display' : 'none'
					}
				};
				return style;
			}
		}, {
			field : 'check',
			checkbox : true,
			width : '0.5%',
			formatter : function(value, row, index) {
				if (row.check == true) {
					// console.log(row.serverName);
					//设置选中
					return {
						checked : true
					};
				}
			}
		}, {
			field : 'files.fileName',
			title : 'FileName',
			width : "30%",
			formatter : forma
		}, {
			field : 'files.security.securityName',
			title : 'Security',
			width : "5%"
		}, {
			field : 'files.fileVersion',
			title : 'Version',
			width : "5%"
		}, {
			field : 'aliasDate',
			title : 'AliasDate',
			sortable : true,
			width : "15%"
		}, {
			field : 'files.user.username',
			title : 'UserName',
			width : "8%"
		} , {
			field : 'location',
			title : 'Location',
			formatter:formatUrl
		} ] ]
	}
	var settingUser = { //此处根据自己需要进行配置
		view : {
			selectedMulti : false, //设置是否能够同时选中多个节点
			showIcon : true, //设置是否显示节点图标
			ShowPlusMinus : false,
			showLine : true, //设置是否显示节点与节点之间的连线
			showTitle : false, //设置是否显示节点的title提示信息
		},
		data : {
			simpleData : {
				enable : true
			}
		},
		callback : {
			onClick : zTreeOnClickRight,
			beforeClick : zTreeBeforeClick,
			onCheck : onCheck
		}
	};
	function zTreeBeforeClick(treeId, treeNode, clickFlag) {
		var str = treeNode.tId
		var treeName = str.substring(0, str.indexOf("_"))
		if (treeName == "deptTree") {
			return true;
		} else {
			return false;
		}
	}
	function onCheck(e, treeId, treeNode) {
		var getSelectRows = $("#tb_order").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		var ids = [];
		var menuIds = [];
		for (var i = 0; i < getSelectRows.length; i++) {
			ids.push(getSelectRows[i].files.security.securityId)
			menuIds.push(getSelectRows[i].files.menu.id)
		}
		console.log(ids)
		var max = ids[0];
		var len = ids.length; 
		for (var i = 1; i < len; i++){ 
		if (ids[i] > max) { 
		max = ids[i]; 
		} 
		} console.log(max)
		console.log(menuIds)
		if(treeId=="deptTree"){
		if(max!=undefined&&menuIds.length>0){
			getUserData(treeNode.name,max,unique(menuIds));
		}
		}
	}
	// 部门树的单击事件
	function zTreeOnClickRight(event, treeId, treeNode, clickFlag) {
		var getSelectRows = $("#tb_order").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		console.log(getSelectRows[0].files.security.securityId)
		var ids = [];
		var menuIds = [];
		for (var i = 0; i < getSelectRows.length; i++) {
			ids.push(getSelectRows[i].files.security.securityId)
			menuIds.push(getSelectRows[i].files.menu.id)
		}
		console.log(ids)
		var max = ids[0];
		var len = ids.length; 
		for (var i = 1; i < len; i++){ 
		if (ids[i] > max) { 
		max = ids[i]; 
		} 
		} console.log(max)
		console.log(menuIds)
		if(treeId=="deptTree"){
		if(max!=undefined&&menuIds.length>0){
			getUserData(treeNode.name,max,unique(menuIds));
		}
		}
	}
	//根据选择的部门和文件对应的菜单Id集合获取有相应权限的用户
	function getUserData(deptname,id,menuIds){
		console.log(deptname)
		console.log(id)
		console.log(menuIds)
		$.ajax({
			type : "post",
			url : "/listUserBySecretlevel",
			data : {
				deptname : deptname,
				id : id,
				menuIds:menuIds
			},
			async : false,
			dataType : "json",
			success : function(data) {
				if(data!=null){
					//$("#userNull").css("display","none")
					//data = JSON.parse(JSON.stringify(data).replace(/username/g,"name"));
					//$.fn.zTree.init($("#userTree"), settingUser, data);
					console.log(data)
					$('#tb_deptUser').bootstrapTable('load', data);
				}else{
					$('#tb_deptUser').bootstrapTable('load', "");
				}
			}
		})
		
	}
	//去重
	function unique(arr){
		var hash=[];
		  for (var i = 0; i < arr.length; i++) {
		    for (var j = i+1; j < arr.length; j++) {
		      if(arr[i].id ==arr[j].id){
		        ++i;
		      }
		    }
		      hash.push(arr[i]);
		  }
		  return hash;
	}
	$(function() {
		deptData()
		$("#tb_user").bootstrapTable({
			data : tabledata,
			cache : false, // 是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
			pagination : true, //是否显示分页（*）
			paginationShowPageGo : true,
			pageNumber : 1, //初始化加载第一页，默认第一页
			pageSize : 5, //每页的记录行数（*）
			pageList : [ 10, 15, 20, 30, 50 ], //可供选择的每页的行数（*）
			clickToSelect : true, //是否启用点击选中行
			sortable : false, //是否启用排序
			//sortOrder : "asc", //排序方式
			sidePagination : "client", //分页方式：client客户端分页，server服务端分页（*）
			queryParamsType : '',
			queryParams : function(params) {//自定义参数，这里的参数是传给后台的，我这是是分页用的
				return {//这里的params是table提供的
					username : $("#nameInput").val(),
					pageNumber : params.pageNumber,
					pageSize : params.pageSize
				};
			},
			columns : usercolumns
		})
		dataAll('/aliasFileById')
		//获取登录者是否有系统标签权限
		 $.ajax({
			type : 'POST',
			url : "/getUserButton",
			data : {
				userId : sessionUser.userId
			},
			async : false,
			dataType : "json",
			success : function(data) {
				console.log(data)
				if (data != null) {
					for (var i = 0; i < data.length; i++) {
						if (data[i].btnName == '系统标签') {
							$("#prompt").css("display", "none");
							$("#sysAlias").css("display", "");
						}
					}
				}
			}
		}) 

	})
	//加载表格数据
	function dataAll(tableUrl) {
		$("#tb_order").bootstrapTable('refresh');
		$("#tb_order").bootstrapTable({
			url : tableUrl, //请求后台的URL（*）
			method : "post", //请求方式（*）
			contentType : "application/x-www-form-urlencoded",//post请求的话就加上这个句话
			toolbar : "#toolbar", //工具按钮用哪个容器
			cache : false, // 是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
			pagination : true, //是否显示分页（*）
			paginationShowPageGo : true,
			pageNumber : 1, //初始化加载第一页，默认第一页
			pageSize : 15, //每页的记录行数（*）
			pageList : [ 10, 15, 20, 30, 50 ], //可供选择的每页的行数（*）
			clickToSelect : true, //是否启用点击选中行
			sortable : true, //是否启用排序
			//sortOrder : "desc", //排序方式
			sidePagination : "server", //分页方式：client客户端分页，server服务端分页（*）
			queryParamsType : '',
			queryParams : function(params) {//自定义参数，这里的参数是传给后台的，我这是是分页用的
				return {//这里的params是table提供的
					aliasId : $("#aliasId").val(),
					aliasType : $("#aliasType").val(),
					fileName:$("#searchInput").val(),
					sortOrder:this.sortOrder,
					pageNumber : params.pageNumber,
					pageSize : params.pageSize
				};
			},
			columns : columns
		});
		 $("#tb_user").bootstrapTable({
				data : tabledata,
				cache : false, // 是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
				pagination : true, //是否显示分页（*）
				paginationShowPageGo : true,
				pageNumber : 1, //初始化加载第一页，默认第一页
				pageSize : 10, //每页的记录行数（*）
				pageList : [ 10, 15, 20, 30, 50 ], //可供选择的每页的行数（*）
				clickToSelect : true, //是否启用点击选中行
				sortable : false, //是否启用排序
				//sortOrder : "asc", //排序方式
				sidePagination : "client", //分页方式：client客户端分页，server服务端分页（*）
				queryParamsType : '',
				queryParams : function(params) {//自定义参数，这里的参数是传给后台的，我这是是分页用的
					return {//这里的params是table提供的
						username : $("#nameInput").val(),
						pageNumber : params.pageNumber,
						pageSize : params.pageSize
					};
				},
				columns : usercolumns
			})
			$("#tb_deptUser").bootstrapTable({
			cache : false, // 是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
			pagination : true, //是否显示分页（*）
			paginationShowPageGo : true,
			pageNumber : 1, //初始化加载第一页，默认第一页
			pageSize : 10, //每页的记录行数（*）
			pageList : [ 10, 15, 20, 30, 50 ], //可供选择的每页的行数（*）
			clickToSelect : true, //是否启用点击选中行
			sortable : false, //是否启用排序
			//sortOrder : "asc", //排序方式
			sidePagination : "client", //分页方式：client客户端分页，server服务端分页（*）
			queryParamsType : '',
			search : true,
			columns : usercolumns
			//onDblClickRow: function (row) {
		    //    $('#tb_user').bootstrapTable('append', row);
			//}
		})
		$('#tb_order').children().children().children('th').eq(0).css(
				"display", "none");
	}
	//美化文件路径
	function formatUrl(value, row, index){
		if(row.files.location){
			var str=row.files.location.replace(/>/g,"<span style='color:blue'>➜</span>");
			//console.log(str)
			str=str.replace(/→/g,"<span style='color:blue'>➜</span>")
			return str;
		}
	}
	//搜索文件名称字体变红
	function forma(value, row, index) {
		if (row.files.fileName) {
			var namestr=row.files.fileName;
				if($("#searchInput").val()!=""){
					var array = namestr.split($("#searchInput").val());
					namestr="";
					for(var j = 0;j<array.length;j++){
						if(j==array.length-1){
							namestr+=array[j]
						}else{
							namestr+=array[j]+"<span style='color:red;'>"+$("#searchInput").val()+"</span>"
						}
					}
				}
			return "<a style='color: #1963AA;text-decoration: none;' href='javascript:void(0)' target='_blank' onclick='showfile(this)'>"
					+ namestr+ "<a/>";
		}
	}
	//点击文件名称,打开文件
	function showfile(file) {
		var fileId = $(file).parent().parent().children('td').eq(0).text();
		var secName = $(file).parent().parent().children('td').eq(4).text();
		var fileName = file.innerText;
		var filestr = fileName.substr(0, fileName.lastIndexOf(".") + 1);
		var fileType = fileName.replace(filestr, "");
		/* if (user.secretlevel == "B") {
			var cont = updateCount(fileId);
			if (cont) {
				openFile(fileType, fileId);
			}
		} else if (user.secretlevel == "C") {
			if (secName != "机密") {
				var cont = updateCount(fileId);
				if (cont) {
					openFile(fileType, fileId);
				}
			} else {
				$.showErr("您没有此权限");
			}
		} else if (user.secretlevel == "D") {
			if (secName == "非密") {
				var cont = updateCount(fileId);
				if (cont) {
					openFile(fileType, fileId);
				}
			} else {
				$.showErr("您没有此权限");
			}
		} */
		var cont = updateCount(fileId);
		if (cont) {
			openFile(fileType, fileId);
		}
	}
	//更新文件点击次数
	function updateCount(fId) {
		var isSuccess;
		$.ajax({
			type : 'POST',
			url : "/updateCounts",
			async : false,
			data : {
				userId : sessionUser.userId,
				fileId : fId
			},
			success : function(data) {
				if (data != null && data > 0) {
					isSuccess = data;
				} else {
					isSuccess = 0;
				}
			}
		})
		return isSuccess;
	}
	var pageofficeHeight= window.screen.height
	var pageofficeWidth= window.screen.width
	//打开文件方式
	function openFile(fileType, fileId,fileSize) {
		if (fileType == "pdf") {
			POBrowser.openWindowModeless("/pdf?fileId=" + fileId,"width="+pageofficeWidth+"px;height="+pageofficeHeight+"px;");
		} else if (fileType == "xls" || fileType == "xlsx") {
		//	window.location.href = '/office?url=html/list.html&fileId=' + fileId+'&state=1&tabsId='+tabsId
			window.open("/office?url=html/list.html&fileId="+fileId,'newwindow', 'height='+(pageofficeHeight-150)+', width='+(pageofficeWidth-150)+', toolbar=no, menubar=no,scrollbars=no, resizable=no,location=n o, status=no');
		} else if (fileType == "doc" || fileType == "docx" ||fileType == "ppt" || fileType == "pptx") {
			POBrowser.openWindowModeless("/word?type=0&fileId=" + fileId,
					"width="+pageofficeWidth+"px;height="+pageofficeHeight+"px;");
		} else if(fileType == "csv") {
			window.open('html/OpenCSV.html?fileId=' + fileId+'&type=0','newwindow', 'height=600, width=800,top=100, left=300, toolbar=no, menubar=no,scrollbars=no, resizable=no,location=n o, status=no');
		}else if(fileType == "txt"||fileType == "TXT"||fileType == "OUT"||fileType == "out"||fileType == "ric"||fileType == "RIC"||fileType == "bin"||fileType == "BIN"){
			window.open('Opentxt.html?fileId='+fileId,'newwindow', 'height=500, width=500,top=100, left=300, toolbar=no, menubar=no,scrollbars=no, resizable=no,location=n o, status=no');
		}else if(fileType =="jpg"||fileType =="JPG"||fileType =="PNG"||fileType =="png"){
			 window.open("/openJpg?fileId="+fileId,'newwindow', 'height=500, width=500,top=100, left=300, toolbar=no, menubar=no,scrollbars=no, resizable=no,location=n o, status=no');
		}else if(fileType =="MP4"||fileType =="mp4"||fileType =="wmv"||fileType =="WMV"){
			 window.open("OpenVideo.html?fileId="+fileId,'newwindow', 'height=500, width=500,top=100, left=300, toolbar=no, menubar=no,scrollbars=no, resizable=no,location=n o, status=no');
		}else{
			$("#notOpenModel").modal("show");
		}
	}
	//获取部门信息
	function deptData() {
		$.ajax({
			type : 'POST',
			url : "/getDeptAll",
			datatype : "json",
			success : function(data) {
				console.log(data)
				$.fn.zTree.init($("#deptTree"), settingUser, getDeptData(data));
			}
		})
	}
	//部门有无子级数据整理
	function getDeptData(array) {
		for (var i = 0; i < array.length; i++) {
			array[i].name = array[i].deptName
			if (array[i].children != undefined && array[i].children.length > 0) {
				getDeptData(array[i].children)
			} else {
				delete array[i].children
			}
		}
		return array;
	}
	//添加分享用户
	function allleft(){
		var getSelectRows = $("#tb_user").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		var rows = $('#tb_user').bootstrapTable('getData');
		for (var i = 0; i < rows.length; i++) {
			for (j = 0; j < getSelectRows.length; j++) {
				if (rows[i].id == getSelectRows[j].id) {
					rows.splice(i, 1);
				}
			}
		}
		$("#tb_user").bootstrapTable('load', rows);
	}
	//移除分享用户
	function allright(){
		var getSelectRows = $("#tb_deptUser").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		if(getSelectRows.length>0){
			for (var i = 0; i < getSelectRows.length; i++) {
				delete getSelectRows[i].ck
				tabledata.push(getSelectRows[i])
			}
		//	distinct(tabledata)
			$("#tb_user").bootstrapTable('load', unique(tabledata));
		}else{
			console.log('请选择')
		}
	}
</script>
</head>

<body>
	<div id="box" style="height: 99%">
			<div id="leftHeight"
				style="width:20%;height: 99%;border-right: 1px solid rgb(204, 204, 204);float:left;">
				<div style="text-align:center;margin-top: 10px">
					<strong th:text="#{plabel}">个人标签</strong>
				</div>
				<div class="tobar" style="padding:0px 0px 0px 30px;">
					<button type="button" class="btn btn-default btn-sm"
						onclick="addFolder()" style="width: 45px !important; ">
						<span th:text="#{add}"></span>
					</button>

					<button type="button" class="btn btn-default btn-sm"
						style="width: 45px !important;" onclick="editFolder()">
						<span th:text="#{modification}"></span>
					</button>
					<button type="button" class="btn btn-default btn-sm"
						style="width: 45px !important;" onclick="deleteFolder()">
						<span th:text="#{delete}"></span>
					</button>
				</div>
				<ul id="pertree" class="ztree"
					style="margin: 5px 0px 0px 0px;padding: 0px;width: 100%;height: 40%; color: #666;border-bottom:1px solid rgb(204, 204, 204) ">
				</ul>
				<div style="text-align:center;margin-top: 10px">
					<strong th:text="#{slabel}">系统标签</strong>
				</div>
				<div class="tobar" id="sysAlias"
					style="padding:0px 0px 0px 30px;display:none;">
					<button type="button" class="btn btn-default btn-sm"
						onclick="addSysFolder()" style="width: 45px !important; ">
						<span th:text="#{add}"></span>
					</button>

					<button type="button" class="btn btn-default btn-sm"
						style="width: 45px !important;" onclick="editSysFolder()">
						<span th:text="#{modification}"></span>
					</button>
					<button type="button" class="btn btn-default btn-sm"
						style="width: 45px !important;" onclick="deleteSysFolder()">
						<span th:text="#{delete}"></span>
					</button>
				</div>
				<ul id="systree" class="ztree"
					style="margin: 5px 0px 0px 0px;padding: 0px;width: 100%;height: 40%;">
				</ul>

				<input id="aliasId" style="display: none;" value="0" /> <input
					id="aliasType" style="display: none;" value="0" />
					<span style="font-size: 12px;position: absolute;bottom: 10px;left:20px;" id="prompt"><span style="color:red">*</span>普通用户只能查看标签</span>
			</div>
			<div id="rightCont" style="width:78%;float:right;">
			
				<table id="tb_order" style="width:100%;height:99% ;">
				</table>

				<div id="toolbar" class="btn-group" style="margin-top: 3px;">
					<button id="btn_delete" type="button"
						class="btn btn-white btn-default btn-round" 
						onclick="delbtn()">
						<span th:text="#{delete}"></span>
					</button>
					<button type="button" class="btn btn-white btn-default"
						 id="btn_down" onclick="dowbtn()">
						<span th:text="#{download}"></span>
					</button>
					<button type="button" class="btn btn-white btn-default"
						onclick="sharebtn()">
						<span th:text="#{share}"></span>
					</button>
					<div class="input-group" style="margin-left:5px;">
							<input type="text" class="form-control" autocomplete="off"
								th:placeholder='#{searchFileName}'
								style="background: none;width: 217px;color:#333 !important;"
								id="searchInput"> <span class="input-group-btn">
								<button class=" btn-default"
									style="position: absolute;padding: 4px 8px;
		top: 0px;
        left: 7px;
    border: none !important; 
    background: none !important;
    color: #333;border: 1px solid #ccc !important;
    border-radius: 5px !important;"
									type="button" onclick="searchFolder()">
									<i class="icon-search"></i>
								</button>
							</span>
						</div>
				</div>
				<span style="font-size: 16px;position: absolute;bottom: 10px;right:20px;" id="hint"><span style="color:red">*</span>请点击左侧标签查看数据</span>
			</div>
		<!-- 分享弹出窗口begin -->
		<div class="modal fade" id="shareModal" tabindex="-1" role="dialog"
			aria-labelledby="addRoleLabel" aria-hidden="true"
			style="height: 550px;">
			<div class="modal-dialog" style="width: 800px;">
				<div class="modal-content">
					<div class="modal-header" style="padding:8px;">
						<button type="button" class="close" data-dismiss="modal"
							aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="addRoleLabel">选择用户</h4>
					</div>
					<div class="modal-body" style="height:500px;">
						<div style="width:100%;height:100%;">
							<input type="text" id="roleUser" style="display:none" />
							<div
								style="width:20%;height:100%;float: left;border-right: 1px solid rgb(204, 204, 204);overflow: auto;">
								<ul class="ztree" id="deptTree"></ul>
							</div>
							<div
								style="width:35%;height:100%;float: left;border-right: 1px solid rgb(204, 204, 204);overflow: auto;" id="div_deptUser">
								<table id="tb_deptUser" style="height:100%;width:100%"></table>
							</div>
							<div
								style="float: left;width:5%;height:100%;float: left;border-right: 1px solid rgb(204, 204, 204); overflow: auto;">
								<div style="position: relative;top:30%">
									<img onclick="allleft()" src="../assets/images/allleft.png" />
									<!-- <img onclick="" src="../assets/images/left.png"/>
								<img onclick="" src="../assets/images/right.png"/> -->
									<img onclick="allright()" src="../assets/images/allright.png" />
								</div>
							</div>
							<div style="float: left;height:100%;width:35%;overflow: auto;" id="div_user">
								<table id="tb_user" style="height:100%;width:100%"></table>
							</div>
						</div>
					</div>
					<div class="modal-footer" style="padding:5px;">
						<button type="button" class="btn new-tijiao queding"
							onclick="shareMessage()" th:text="#{submit}">分享</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal -->
		</div>
		<!-- 分享弹出窗口end -->
		<!-- 编辑第三方软件弹出窗口begin -->
		<div class="modal fade" id="editModal" tabindex="-1" role="dialog"
			style="height: 550px;">
			<div class="modal-dialog" style="width: 800px;">
				<div class="modal-content">
					<div class="modal-header" style="height: 50px;">
						<button type="button" class="close" data-dismiss="modal"
							aria-hidden="true">&times;</button>
						<h4 class="modal-title">系统提示</h4>
					</div>
					<div class="modal-body" style="height: 350px;padding: 0px 10px;">
						<div class="row">
							<div class="col-md-12">
								<h3>无法在线编辑，请选择本地软件打开</h3>
								<input type="file" class="file">
							</div>
						</div>
					</div>
					<div class="modal-footer" style="height: 70px;">
						<button type="button" class="btn new-tijiao queding"
							th:text="#{submit}">提交</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal -->
		</div>
		<!-- 编辑第三方软件弹出窗口end -->
		<!-- 新建分类 -->
		<div class="modal fade" id="addFolder" tabindex="-1" role="dialog"
			style="">
			<div class="modal-dialog" style="width:500px;">
				<div class="modal-content">
					<div class="modal-header" style="height: 50px;">
						<button type="button" class="close" data-dismiss="modal"
							aria-hidden="true">&times;</button>
						<h4 class="modal-title">新增标签</h4>
					</div>
					<div class="modal-body" style="padding: 0px 10px;">

						<table>
							<tr>
								<td>标签名称:</td>
								<td><input class="form-control" type="text" id="folderName"
									placeholder="请输入名称" autocomplete="off" /></td>
								<td><select class="form-control" id="lv"><option
											value="0">同级</option>
										<option value="1">子级</option></select></td>
							</tr>
						</table>

					</div>
					<div class="modal-footer" style="height: 70px;">
						<button type="button" class="btn new-tijiao queding"
							onclick="saveFolder()" th:text="#{submit}">保存</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal -->
		</div>
		<!-- 新建分类 -->
		<!-- 修改分类 -->
		<div class="modal fade" id="editFolder" tabindex="-1" role="dialog"
			style="">
			<div class="modal-dialog" style="">
				<div class="modal-content">
					<div class="modal-header" style="height: 50px;">
						<button type="button" class="close" data-dismiss="modal"
							aria-hidden="true">&times;</button>
						<h4 class="modal-title">修改标签</h4>
					</div>
					<div class="modal-body" style="padding: 0px 10px;">
						<table>
							<tr>
								<td>标签名称:</td>
								<td><input class="form-control" type="text" id="updateName"
									placeholder="请输入名称" autocomplete="off" /></td>
							</tr>
						</table>
					</div>
					<div class="modal-footer" style="height: 70px;">
						<button type="button" class="btn new-tijiao queding"
							onclick="updateFolder()" th:text="#{submit}">保存</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal -->
		</div>
		<!-- 修改分类 -->
	</div>
</body>
<script>
	$.showConfirm = function(str, funcok, funcclose, confirm) {
		BootstrapDialog.confirm({
			title : funcclose,
			message : str,
			type : BootstrapDialog.TYPE_WARNING,
			// BootstrapDialog.TYPE_PRIMARY
			closable : true, // 点击对话框以外的页面内容可关闭
			draggable : false, //可拖拽
			btnOKLabel : confirm,
			btnOKClass : 'btn-warning',
			size : BootstrapDialog.SIZE_SMALL,
			// 对话框关闭的时候执行方法
			onhide : funcclose,
			callback : function(result) {
				if (result) {
					console.log(funcok)
					$.post("/deleteAliasFile", {
						fileIds : funcok,
						aliasId : $("#aliasId").val()
					}, function(data) {
						if (data != null) {
							deleteSuccess()
							$('#tb_order').bootstrapTable('refresh');
						}
					});
				}
			}
		});
	};
	$.showConfirmAlias = function(str, funcok, funcclose, confirm) {
		BootstrapDialog.confirm({
			title : funcclose,
			message : str,
			type : BootstrapDialog.TYPE_WARNING,
			// BootstrapDialog.TYPE_PRIMARY
			closable : true, // 点击对话框以外的页面内容可关闭
			draggable : false, //可拖拽
			btnOKLabel : confirm,
			btnOKClass : 'btn-warning',
			size : BootstrapDialog.SIZE_SMALL,
			// 对话框关闭的时候执行方法
			onhide : funcclose,
			callback : function(result) {
				if (result) {
					console.log(funcok)
					$.post("/deleteAlias", {
						aliasIds : funcok
					}, function(data) {
						if (data != null) {
							$("#aliasId").val(0)
							dataAll('/aliasFileById');
							deleteSuccess()
							aliasByUser();
						}
					});
				}
			}
		});
	};
	var htmlIcon = "<i style='color: red;position: relative;top: 2px;font-size: 27px;left: -6px;' class='icon-remove new-icon'></i>"
	var setting = { //此处根据自己需要进行配置
		view : {
			enable : true,
			showLine : false,
			showIcon : true, //设置是否显示节点图标
			nameIsHTML : true
		},
		edit: {
			enable: true,
			showRemoveBtn: false,
			showRenameBtn: false
		},
		data: {
			simpleData: {
				enable: true
			}
		},
		callback : {
			 beforeDrag:beforeDrag,
			 beforeDrop:beforeDrop,
			 onClick : zTreeOnClickRight,
			 onMouseUp : treeUp
		}
	};
	function treeUp(action, objId, data) {
		var pertreeobj = $.fn.zTree.getZTreeObj("pertree");
		pertreeobj.cancelSelectedNode();
		var systreeobj = $.fn.zTree.getZTreeObj("systree");
		systreeobj.cancelSelectedNode();
	}
	// 树的单击事件
	function zTreeOnClickRight(event, treeId, treeNode) {
		if(treeNode.children!=undefined){
			return 
		}
		var str = treeNode.tId
		var treeName = str.substring(0, str.indexOf("_"))
		if (treeName == "pertree") {
			var zTreeObj = $.fn.zTree.getZTreeObj("pertree");
			$("#aliasId").val(zTreeObj.getSelectedNodes()[0].aliasId);
			$("#aliasType").val(zTreeObj.getSelectedNodes()[0].aliasType);
		} else if (treeName == "systree") {
			var zTreeObj = $.fn.zTree.getZTreeObj("systree");
			$("#aliasId").val(zTreeObj.getSelectedNodes()[0].aliasId);
			$("#aliasType").val(zTreeObj.getSelectedNodes()[0].aliasType);
		}
		$("#rightCont").css("display", "");
		dataAll('/aliasFileById')
	}
	//拖拽之前调用的函数
	function beforeDrag(treeId,treeNode){
	 //console.log(treeNode)
	}
	 
	//拖拽操作结束之前调用的函数
	function beforeDrop(treeId, treeNode, targetNode, moveType){
 		var result=false;
		if(moveType == 'inner'){
			var cont=dataByAliasId(targetNode.aliasId).length
			if(cont>0){
				moverChildrenErr()
				return false;
			}else{
			    result=aliasByParentId(treeNode[0].aliasId,targetNode.aliasId);
			    aliasByUser();
				return result;
			}
		}else{
			result=aliasByParentId(treeNode[0].aliasId,targetNode.parentId);
			aliasByUser();
			return result
		}
		aliasByUser();
		return result;
	}
	 
	function aliasByParentId(aliasId,parentId){
		var result;
		$.ajax({
			type : 'POST',
			url : "/updateAliasByParent",
			data : {
				aliasId : aliasId,
				parentId:parentId
			},
			async:false,
			success : function(data) {
				if(data!=null){
					result=true
				}else{
					result=false
				}
			}
		})
		console.log(result)
		return result;
	}
	function aliasByUser() {
		$.ajax({
			type : 'POST',
			url : "/aliasByUser",
			data : {
				userId : sessionUser.userId
			},
			success : function(data) {
				console.log(data)
				data = JSON.parse(JSON.stringify(data).replace(/aliasName/g,
						"name"));
				if (data != null) {
					data = getChildren(data);
					console.log(data)
					for (var i = 0; i < data.length; i++) {
						if (data[i].aliasType == 1) {
							$.fn.zTree.init($("#systree"), setting,
									data[i].children);
						} else {
							$.fn.zTree.init($("#pertree"), setting,
									data[i].children);
						}
					}
				}
			}
		})
	}
	function getChildren(array) {
		for (var i = 0; i < array.length; i++) {
			if (array[i].children != "undefined"
					|| array[i].children != undefined) {
				if (array[i].children != "null" && array[i].children != null
						&& array[i].children.length != 0) {
					getChildren(array[i].children)
				} else {
					delete array[i].children
				}
			}
			if (array[i].aliasType == 2) {
				//array[i].name="<font color='#CC7003'>"+array[i].name+"</font>"
			} else {
				//array[i].name="<font color='#1B94C8'>"+array[i].name+"</font>"
			}
		}
		return array;
	}
	function getByAliasById(aliasIds) {
		$.ajax({
			type : 'POST',
			url : "/getByAliasById",
			data : {
				aliasIds : aliasIds
			},
			success : function(data) {
				app.aliasAll = data
				console.log(data)
			}
		})
	}
	$(function() {
		aliasByUser();
	})

	function dowbtn() {
		var fileIdAll = [];
		var getSelectRows = $("#tb_order").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		if (getSelectRows.length == 0) {
			nullErr();
		} else {
			for (i = 0; i < getSelectRows.length; i++) {
				fileIdAll.push(getSelectRows[i].files.fileId)
			}
			$.ajax({
				type : 'POST',
				url : "/isFileRole",
				data : {
					fileIds : fileIdAll
				},
				async : false,
				success : function(data) {
					console.log(data)
					if(data=="ok"){
						 if (getSelectRows.length == 1) {
						window.location.href = "/download?fileId="
								+ getSelectRows[0].files.fileId;
					} else {
						window.location.href = "/downloadFiles?fileIds="+fileIdAll;
					}  
					}else if(data=="no"){
						dowErr()
					}
				}
			})
		}
	}
	function delbtn(index) {
		var fileIdAll = [];
		var getSelectRows = $("#tb_order").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		if (getSelectRows.length == 0) {
			nullErr();
		} else {
			for (i = 0; i < getSelectRows.length; i++) {
				fileIdAll.push(getSelectRows[i].files.fileId)
			}
			console.log(fileIdAll)
			if (lang != "en_US") {
				$.showConfirm(htmlIcon + "确认要删除吗？", fileIdAll, "删除文件", "确认");
			} else {
				$.showConfirm(htmlIcon + "Are you sure you want to delete it?",
						fileIdAll, "DeleteFile", "confirm");
			}
		}
	}
	function editbtn() {
		var getSelectRows = $("#tb_order").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		if (getSelectRows.length == 0) {
			nullErr();
		} else if (getSelectRows.length > 1) {
			oneErr();
		} else {
			$("#editModal").modal("show");
		}
	}
	function sharebtn() {
		var getSelectRows = $("#tb_order").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		if (getSelectRows.length == 0) {
			nullErr();
		} else {
			$('#shareModal').modal('show');
			deptData()
		}
	}
	function shareMessage() {
		var userRows = $('#tb_user').bootstrapTable('getData');
		var dataRows = $("#tb_order").bootstrapTable('getSelections',
				function(row) {
					return row;
				});
		var dataAll = [];
		for (i = 0; i < userRows.length; i++) {
			var fileIdAll = [];
			for (j = 0; j < dataRows.length; j++) {
				fileIdAll.push(dataRows[j].files.fileId)
			}
			dataAll.push({
				"userId" : userRows[i].userId,
				"dataFile" : fileIdAll
			})

		}
		$.ajax({
			type : 'POST',
			url : "/insertMessage",
			data : {
				dataAll : JSON.stringify(dataAll)
			},
			success : function(data) {
				console.log(data)
				if (data == "ok") {
					$('#shareModal').modal('hide');
					shareSuccess()
					$("#tb_order").bootstrapTable('refresh');
				} else {
					shareErr()
				}
			}
		})
	}
	function itemClick(info) {
		console.log(info)
		$("#aliasType").val(info.aliasType);
		$("#aliasId").val(info.aliasId);
		$("#rightCont").css("display", "");
		
		$("#hint").css("display", "none");
		dataAll('/aliasFileById');
	}
	function searchUser() {
		$("#userTable").bootstrapTable('destroy');
		userAll();
	}
	function addFolder() {
		//var nodes = $('#treeview').treeview('getSelected');
		var treeObj = $.fn.zTree.getZTreeObj("pertree");
		if(treeObj!=null&&treeObj.getNodes().length>0){
			var nodes = treeObj.getSelectedNodes();
			if (nodes.length != 0) {
				$("#addFolder").modal('show');
			} else {
				selectErr()
			}
		}else {
			$("#aliasType").val(2);
			$("#addFolder").modal('show');
		}
		
	}
	function addSysFolder() {
		//var nodes = $('#treeview').treeview('getSelected');
		var systreeObj = $.fn.zTree.getZTreeObj("systree");
		if(systreeObj!=null&&systreeObj.getNodes().length>0){
		var sysnodes = systreeObj.getSelectedNodes();
		if (sysnodes.length != 0) {
			$("#addFolder").modal('show');
		} else {
			selectErr()
		}
		}else{
			$("#aliasType").val(1);
			$("#addFolder").modal('show');
		}
	}
	function saveFolder() {
		var parentId = 0;
		var treeObj = $.fn.zTree.getZTreeObj("pertree");
		var systreeObj = $.fn.zTree.getZTreeObj("systree");
		var nodes=""
		var sysnodes=""
		if(treeObj!=null&&treeObj.getNodes().length>0){
			 nodes = treeObj.getSelectedNodes();
			if (nodes.length > 0&&sysnodes=="") {
				if ($("#lv").val() == 0) {
					if (nodes[0].parentId != undefined) {
						parentId = nodes[0].parentId;
					}
				} else {
					parentId = nodes[0].aliasId;
				}
			}else{
				selectErr()
			}
		}else{
			parentId= $("#aliasType").val()
		}
		if(systreeObj!=null&&systreeObj.getNodes().length>0){
			 sysnodes = systreeObj.getSelectedNodes();
			  if (sysnodes.length > 0&&nodes=="") {
				if ($("#lv").val() == 0) {
					if (sysnodes[0].parentId != undefined) {
						parentId = sysnodes[0].parentId;
					}
				} else {
					parentId = sysnodes[0].aliasId;
				}
			} else {
				selectErr()
			}
		}else{
			parentId= $("#aliasType").val()
		}
		if($("#lv").val()>0&&dataByAliasId($("#aliasId").val()).length>0){
			aliasChildrenErr()
		}else{
			  $.ajax({
			type : 'POST',
			url : "/addAlias",
			data : {
				aliasName : $("#folderName").val(),
				aliasType : $("#aliasType").val(),
				parentId : parentId
			},
			success : function(data) {
				console.log(data)
				if(data==0){
					existErr();
				}else if (data != null || data != "") {
					$("#addFolder").modal('hide');
					aliasByUser();
					$("#folderName").val("")
					aliasSuccess();
				}else{
					addErr();
				}
			}
		})  
		}
	}
	function dataByAliasId(aliasId){
		var dataAlias;
		$.ajax({
			type : 'POST',
			url : '/listById',
			data : {
				aliasId : aliasId
			},
			async : false,
			success : function(data) {
				if(data!=null){
					dataAlias=data
				}
			}
		})
		return dataAlias
	}
	function editFolder() {
		var treeObj = $.fn.zTree.getZTreeObj("pertree");
		var nodes = treeObj.getSelectedNodes();
		console.log(nodes[0])
		if (nodes.length != 0) {
			$("#updateName").val(nodes[0].name);
			$("#editFolder").modal('show');
		} else {
			selectErr()
		}
	}
	function editSysFolder() {
		var treeObj = $.fn.zTree.getZTreeObj("systree");
		var nodes = treeObj.getSelectedNodes();
		console.log(nodes[0])
		if (nodes.length != 0) {
			$("#updateName").val(nodes[0].name);
			$("#editFolder").modal('show');
		} else {
			selectErr()
		}
	}
	function updateFolder() {
		$.ajax({
			type : 'POST',
			url : "/updateAlias",
			data : {
				aliasName : $("#updateName").val(),
				aliasId : $("#aliasId").val()
			},
			success : function(data) {
				if(data==0){
					existErr();
				}else if (data != null || data != "") {
					$("#editFolder").modal('hide');
					aliasByUser();
				}else{
					addErr();
				}
			}
		})
	}
	function getChildNodes(treeObj,treeNode) { 
        var childNodes = treeObj.transformToArray(treeNode); 
        var nodes = new Array(); 
        for(i = 0; i < childNodes.length; i++) { 
             nodes.push(childNodes[i].aliasId)
        } 
        return nodes; 
} 
	function deleteFolder() {
		var treeObj = $.fn.zTree.getZTreeObj("pertree");
		var nodes = treeObj.getSelectedNodes();
		console.log(nodes)
		console.log(getChildNodes(treeObj,nodes))
		 var aliasIds = getChildNodes(treeObj,nodes);
		if (nodes.length != 0) {
			/* for (var i = 0; i < nodes.length; i++) {
				aliasIds.push(nodes[i].aliasId)
			} */
			if (lang != "en_US") {
				$
						.showConfirmAlias(htmlIcon + "确认要删除吗？", aliasIds,
								"删除标签", "确认");
			} else {
				$.showConfirmAlias(htmlIcon
						+ "Are you sure you want to delete it?", aliasIds,
						"DeleteTag", "confirm");
			}
		} else {
			selectErr()
		} 
	}
	function deleteSysFolder() {
		var treeObj = $.fn.zTree.getZTreeObj("systree");
		var nodes = treeObj.getSelectedNodes();
		var aliasIds = [];
		if (nodes.length != 0) {
			for (var i = 0; i < nodes.length; i++) {
				aliasIds.push(nodes[i].aliasId)
			}
			if (lang != "en_US") {
				$
						.showConfirmAlias(htmlIcon + "确认要删除吗？", aliasIds,
								"删除标签", "确认");
			} else {
				$.showConfirmAlias(htmlIcon
						+ "Are you sure you want to delete it?", aliasIds,
						"DeleteTag", "confirm");
			}
		} else {
			selectErr()
		}
	}
	function searchFolder() {
		//searchData();
		$('#tb_order').bootstrapTable('refresh', {
			url : '/aliasFileById'
		});
		//$("#tb_order").bootstrapTable('load', searchData());
	}

	$("#toolbar > button").bind('click', function() {
		$(this).css("background", "#cc7003");
	});
	$('.modal').on('hide.bs.modal', function() {
		$(".btn").css("background", "#0085ff")
	});
</script>

</html>